<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[crafting code.]]></title>
  <link href="http://www.marcphilipp.de/atom.xml" rel="self"/>
  <link href="http://www.marcphilipp.de/"/>
  <updated>2012-03-19T20:16:48+01:00</updated>
  <id>http://www.marcphilipp.de/</id>
  <author>
    <name><![CDATA[Marc Philipp]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Database Tests With DbUnit (Part 1)]]></title>
    <link href="http://www.marcphilipp.de/blog/2012/03/13/database-tests-with-dbunit-part-1/"/>
    <updated>2012-03-13T21:00:00+01:00</updated>
    <id>http://www.marcphilipp.de/blog/2012/03/13/database-tests-with-dbunit-part-1</id>
    <content type="html"><![CDATA[<p>Inspired by a recent <a href="http://blog.schauderhaft.de/2012/01/15/tipps-for-testing-database-code/">blog post</a> and <a href="http://www.sigs-datacom.de/oop2012/konferenz/sessiondetails.html?tx_mwconferences_pi1%5BshowUid%5D=752&amp;tx_mwconferences_pi1%5Banchor%5D=%23Mi64&amp;tx_mwconferences_pi1%5Bs%5D=0">presentation</a> by <a href="http://blog.schauderhaft.de/uber-jens-schauder/">Jens Schauder</a>, this blog posts starts a series of posts about using <a href="http://www.dbunit.org/">DbUnit</a> for database and integration tests. In addition, I will talk about <a href="http://www.andrena.de/veranstaltungen/datenbanktests-mit-dbunit">Database Tests with DbUnit</a> at ObjektForum Karlsruhe in April. This first post introduces DbUnit and demonstrates how it can be used to write database tests.</p>

<!--more-->


<p>For tests that use a database it is crucial to be able to set up the database to a known state before each test run. Otherwise such tests tend to be very fragile and will require a lot of manual care to keep them green over time as they will often fail due to different database contents.</p>

<p>Suppose we want to test a class called <code>PersonRepository</code> that loads instances of <code>Person</code> from the database. For example, the method <code>findPersonByFirstName</code> should load the (first) person with a specified first name. How can we test this method? Our first test might look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">findsAndReadsExistingPersonByFirstName</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">PersonRepository</span> <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PersonRepository</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
</span><span class='line'>  <span class="n">Person</span> <span class="n">charlie</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findPersonByFirstName</span><span class="o">(</span><span class="s">&quot;Charlie&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assertThat</span><span class="o">(</span><span class="n">charlie</span><span class="o">.</span><span class="na">getFirstName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Charlie&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="n">assertThat</span><span class="o">(</span><span class="n">charlie</span><span class="o">.</span><span class="na">getLastName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Brown&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="n">assertThat</span><span class="o">(</span><span class="n">charlie</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="mi">42</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A crucial part is missing though: the setup. We need to prepare the database before we can run the test, i.e. we need to make sure the database contains a person called &#8220;Charlie&#8221; before we can call  <code>findPersonByFirstName</code> and check the result.</p>

<h2>Importing a dataset into the database</h2>

<p>DbUnit offers a useful approach to solving this problem, e.g. it allows to cleanly insert a data set required by a test into the database. Usually, such a data set is specified in a separate XML file, like this:</p>

<figure class='code'><figcaption><span>dataset.xml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dataset&gt;</span>
</span><span class='line'>  <span class="nt">&lt;PERSON</span> <span class="na">NAME=</span><span class="s">&quot;Bob&quot;</span> <span class="na">LAST_NAME=</span><span class="s">&quot;Doe&quot;</span> <span class="na">AGE=</span><span class="s">&quot;18&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;PERSON</span> <span class="na">NAME=</span><span class="s">&quot;Alice&quot;</span> <span class="na">LAST_NAME=</span><span class="s">&quot;Foo&quot;</span> <span class="na">AGE=</span><span class="s">&quot;23&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;PERSON</span> <span class="na">NAME=</span><span class="s">&quot;Charlie&quot;</span> <span class="na">LAST_NAME=</span><span class="s">&quot;Brown&quot;</span> <span class="na">AGE=</span><span class="s">&quot;42&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/dataset&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simple dataset contains three rows of the <code>PERSON</code> table which has three columns, namely <code>NAME</code>, <code>LAST_NAME</code>, and <code>AGE</code>.</p>

<p>DbUnit can then read the file into an <code>IDataSet</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">IDataSet</span> <span class="nf">readDataSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">FlatXmlDataSetBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;dataset.xml&quot;</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we tell DbUnit to load our <code>IDataSet</code> into the database. In this example, we use an in-memory instance of <a href="http://www.h2database.com/">H2</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">cleanlyInsertDataset</span><span class="o">(</span><span class="n">IDataSet</span> <span class="n">dataSet</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">IDatabaseTester</span> <span class="n">databaseTester</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcDatabaseTester</span><span class="o">(</span>
</span><span class='line'>      <span class="s">&quot;org.h2.Driver&quot;</span><span class="o">,</span> <span class="s">&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;</span><span class="o">,</span> <span class="s">&quot;sa&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="n">databaseTester</span><span class="o">.</span><span class="na">setSetUpOperation</span><span class="o">(</span><span class="n">DatabaseOperation</span><span class="o">.</span><span class="na">CLEAN_INSERT</span><span class="o">);</span>
</span><span class='line'>  <span class="n">databaseTester</span><span class="o">.</span><span class="na">setDataSet</span><span class="o">(</span><span class="n">dataSet</span><span class="o">);</span>
</span><span class='line'>  <span class="n">databaseTester</span><span class="o">.</span><span class="na">onSetup</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>CLEAN_INSERT</code> operation instructs DbUnit to delete all rows from the <code>PERSON</code> table and then insert the rows from our dataset into the database. In our test class, we will import the dataset before each test case using the <code>@Before</code> annotation of JUnit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Before</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">importDataSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">IDataSet</span> <span class="n">dataSet</span> <span class="o">=</span> <span class="n">readDataSet</span><span class="o">();</span>
</span><span class='line'>  <span class="n">cleanlyInsertDataset</span><span class="o">(</span><span class="n">dataSet</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the database schema</h2>

<p>However, before we can load the dataset into the database, we have to ensure that the database schema has been created. Since we are using a non-persistent H2 instance we can simply create the schema before running our first test case. In JUnit, this can be achieved using the <code>@BeforeClass</code> annotation like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@BeforeClass</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createSchema</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">RunScript</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;</span><span class="o">,</span>
</span><span class='line'>                    <span class="s">&quot;sa&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="s">&quot;schema.sql&quot;</span><span class="o">,</span> <span class="n">UTF8</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>RunScript</code> is an utility class provided by H2 that executes the specified SQL file against the specified database. Other databases provide similiar mechanisms to execute SQL files. In our case, the <code>schema.sql</code> file looks like this:</p>

<figure class='code'><figcaption><span>schema.sql </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">PERSON</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">ID</span> <span class="nb">int</span> <span class="k">identity</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
</span><span class='line'>  <span class="n">NAME</span> <span class="nb">varchar</span><span class="p">,</span>
</span><span class='line'>  <span class="n">LAST_NAME</span> <span class="nb">varchar</span><span class="p">,</span>
</span><span class='line'>  <span class="n">AGE</span>  <span class="nb">smallint</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Putting the pieces together</h2>

<p>Our test setup is complete. First, we create the database schema. Second, we import three rows from <code>dataset.xml</code> into the <code>PERSON</code> table. Third, we run our test case.</p>

<p>Here are all the bits and pieces put together:</p>

<figure class='code'><figcaption><span>XmlDatabaseTest.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XmlDatabaseTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JDBC_DRIVER</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">h2</span><span class="o">.</span><span class="na">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JDBC_URL</span> <span class="o">=</span> <span class="s">&quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">USER</span> <span class="o">=</span> <span class="s">&quot;sa&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@BeforeClass</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createSchema</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">RunScript</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">JDBC_URL</span><span class="o">,</span> <span class="n">USER</span><span class="o">,</span> <span class="n">PASSWORD</span><span class="o">,</span> <span class="s">&quot;schema.sql&quot;</span><span class="o">,</span> <span class="n">UTF8</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Before</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importDataSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">IDataSet</span> <span class="n">dataSet</span> <span class="o">=</span> <span class="n">readDataSet</span><span class="o">();</span>
</span><span class='line'>      <span class="n">cleanlyInsert</span><span class="o">(</span><span class="n">dataSet</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">IDataSet</span> <span class="nf">readDataSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">FlatXmlDataSetBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;dataset.xml&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">cleanlyInsert</span><span class="o">(</span><span class="n">IDataSet</span> <span class="n">dataSet</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">IDatabaseTester</span> <span class="n">databaseTester</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcDatabaseTester</span><span class="o">(</span><span class="n">JDBC_DRIVER</span><span class="o">,</span> <span class="n">JDBC_URL</span><span class="o">,</span> <span class="n">USER</span><span class="o">,</span> <span class="n">PASSWORD</span><span class="o">);</span>
</span><span class='line'>      <span class="n">databaseTester</span><span class="o">.</span><span class="na">setSetUpOperation</span><span class="o">(</span><span class="n">DatabaseOperation</span><span class="o">.</span><span class="na">CLEAN_INSERT</span><span class="o">);</span>
</span><span class='line'>      <span class="n">databaseTester</span><span class="o">.</span><span class="na">setDataSet</span><span class="o">(</span><span class="n">dataSet</span><span class="o">);</span>
</span><span class='line'>      <span class="n">databaseTester</span><span class="o">.</span><span class="na">onSetup</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">findsAndReadsExistingPersonByFirstName</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">PersonRepository</span> <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PersonRepository</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
</span><span class='line'>      <span class="n">Person</span> <span class="n">charlie</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findPersonByFirstName</span><span class="o">(</span><span class="s">&quot;Charlie&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">assertThat</span><span class="o">(</span><span class="n">charlie</span><span class="o">.</span><span class="na">getFirstName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Charlie&quot;</span><span class="o">));</span>
</span><span class='line'>      <span class="n">assertThat</span><span class="o">(</span><span class="n">charlie</span><span class="o">.</span><span class="na">getLastName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;Brown&quot;</span><span class="o">));</span>
</span><span class='line'>      <span class="n">assertThat</span><span class="o">(</span><span class="n">charlie</span><span class="o">.</span><span class="na">getAge</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="mi">42</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsNullWhenPersonCannotBeFoundByFirstName</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">PersonRepository</span> <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PersonRepository</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
</span><span class='line'>      <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findPersonByFirstName</span><span class="o">(</span><span class="s">&quot;iDoNotExist&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">assertThat</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">nullValue</span><span class="o">()));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">JdbcDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcDataSource</span><span class="o">();</span>
</span><span class='line'>      <span class="n">dataSource</span><span class="o">.</span><span class="na">setURL</span><span class="o">(</span><span class="n">JDBC_URL</span><span class="o">);</span>
</span><span class='line'>      <span class="n">dataSource</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">USER</span><span class="o">);</span>
</span><span class='line'>      <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">PASSWORD</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, there&#8217;s still some room for improvement. For example, <code>createSchema()</code>, <code>cleanlyInsert()</code>, and <code>dataSource()</code> have yet to be made reusable by other test classes. However, this would destroy the self-containedness of the test which is important for this blog post. ;-)</p>

<h2>What&#8217;s next?</h2>

<p>In the next post, we will see how the test data (now hidden away in <code>dataset.xml</code>) can be moved into the test code. Stay tuned!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JUnit Rules]]></title>
    <link href="http://www.marcphilipp.de/blog/2011/12/22/junit-rules/"/>
    <updated>2011-12-22T14:24:00+01:00</updated>
    <id>http://www.marcphilipp.de/blog/2011/12/22/junit-rules</id>
    <content type="html"><![CDATA[<p>Marc Philipp, andrena objects ag<br/>
Stefan Birkner, Immobilien Scout GmbH<br/>
<em>Erschienen in Java aktuell, 1/2012, dem Magazin der <a href="http://www.ijug.eu/">iJUG</a>.</em></p>

<p><em>Automatisierte Tests sind aus der heutigen Softwareentwicklung nicht mehr wegzudenken. JUnit ist das älteste und bekannteste Testing-Framework für Java. Doch selbst ein so etabliertes und einfach zu benutzendes Framework wird kontinuierlich weiterentwickelt. Eine der Neuerungen sind JUnit Rules, die Entwicklern eine neue mächtige Möglichkeit bieten, Tests zu formulieren und besser zu strukturieren.</em></p>

<!--more-->


<p>Der Legende nach haben Kent Beck und Erich Gamma 1997 den Kern von JUnit auf dem Weg zu einer Konferenz im Flugzeug zwischen Zürich und Atlanta geschrieben. JUnit griff die Idee wieder auf, die Beck 1994 mit SUnit [<a href="http://www.xprogramming.com/testfram.htm" title="Kent Beck, Simple Smalltalk Testing: With Patterns">1</a>] für Smalltalk eingeführt hatte: ein Testing-Framework, dessen Zielgruppe Programmierer sind, also dieselben Leute, die auch den Code schreiben, den es zu testen gilt. JUnit ist inzwischen weit verbreitet. Es wird nicht nur zum Schreiben von Unittests, sondern auch zur Automatisierung von Integrations- und Akzeptanztests verwendet.</p>

<p>Viele erfolgreiche Open-Source-Projekte zeichnen sich dadurch aus, dass mit der Zeit immer neue Features eingebaut werden. Dies führt häufig dazu, dass einst simple Bibliotheken unübersichtlich und schwer wartbar werden. JUnit geht hier gezielt einen anderen Weg. David Saff, neben Kent Beck der zweite Maintainer von JUnit, sieht das so: „JUnit is the intersection of all possible useful Java test frameworks, not their union”.</p>

<p>Die Wahrnehmung in der Java-Entwicklergemeinde ist dementsprechend: Da JUnit so einfach ist, meint jeder, der es schon einmal benutzt hat, es gut zu kennen. Das ist einerseits gut, denn die Hürde Unittests zu schreiben ist so sehr niedrig. Andererseits führt es dazu, dass Neuerungen von vielen Entwicklern gar nicht oder erst verzögert wahrgenommen werden. Fragt man Entwicklerkollegen nach Neuerungen in JUnit, wird häufig die Umstellung von Vererbung auf Annotations-basierte Testschreibweise in Version 4.0 erwähnt.</p>

<p>Seitdem hat sich allerdings einiges getan. Die neueste Innovation, die mit Version 4.7 eingeführt wurde, heißt Rules. Zugegeben, unter dem Begriff kann man sich erst einmal nichts vorstellen. Hat man sich diese „Regeln” für Tests aber einmal eingehend angesehen &#8211; und genau das werden wir in diesem Artikel tun &#8211; stellt man fest: Rules werden die Art, wie wir JUnit-Tests schreiben, nachhaltig verändern.</p>

<h2>Was sind Rules?</h2>

<p>Mithilfe von JUnit-Rules lässt sich die Ausführung von Tests beeinflussen. Ähnlich einem Aspekt in der aspektorientierten Programmierung (AOP) kann die Rule Code vor, nach oder anstelle einer Testmethode ausführen [<a href="http://blog.schauderhaft.de/2009/10/04/junit-rules/" title="Blog von Jens Schauder">2</a>]. Hinter dieser abstrakten Beschreibung steckt ein mächtiges Werkzeug, wie die folgenden Beispiele zeigen.</p>

<h2>Standard-Rules</h2>

<p>JUnit selbst liefert fünf Rules mit, an denen wir den praktischen Einsatz zeigen (der Quellcode aller Beispiele ist auf GitHub verfügbar [<a href="http://marcphilipp.github.com/junit-rules/" title="Source Code der Beispiele auf GitHub">3</a>]).</p>

<h3>Temporäre Dateien</h3>

<p>Beim Testen von Code, der Dateioperationen ausführt, steht man häufig vor dem Problem, dass der Test temporär eine Datei benötigt, die nach dem Test wieder gelöscht werden soll. Bisher brachte man den entsprechenden Code in @Before- und @After-Methoden unter, wie das folgende Beispiel zeigt.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TemporaryFolderWithoutRule</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">File</span> <span class="n">folder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Before</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createTemporaryFolder</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">folder</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">&quot;myFolder&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">folder</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
</span><span class='line'>      <span class="n">folder</span><span class="o">.</span><span class="na">mkdir</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">folder</span><span class="o">,</span> <span class="s">&quot;test.txt&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
</span><span class='line'>      <span class="n">assertTrue</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@After</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteTemporaryFolder</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">recursivelyDelete</span><span class="o">(</span><span class="n">folder</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">recursivelyDelete</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">files</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">each</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">recursivelyDelete</span><span class="o">(</span><span class="n">each</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dieser Test kann mit der <code>TemporaryFolder</code>-Rule wesentlich kürzer und prägnanter formuliert werden, da die Rule den Framework-Code kapselt.</p>

<p>Um die Rule zu verwenden, muss innerhalb des Tests ein Feld vom Typ <code>TemporaryFolder</code> angelegt werden. Dieses Feld muss <code>public</code> sein und mit der Annotation <code>@Rule</code> markiert werden, sodass JUnit die Rule erkennt. So markierte Rules wirken sich auf die Ausführung aller Testmethoden einer Testklasse aus.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TemporaryFolderWithRule</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">TemporaryFolder</span> <span class="n">folder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemporaryFolder</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="na">newFile</span><span class="o">(</span><span class="s">&quot;test.txt&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">assertTrue</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Die Testmethode <code>test()</code> legt mithilfe der <code>TemporaryFolder</code>-Rule die Datei <code>test.txt</code> an und überprüft danach, dass die Datei erzeugt wurde. Doch wo wurde die Datei erzeugt? Der Name <code>TemporaryFolder</code> suggeriert es bereits: in einem temporären Ordner. Doch die Rule legt die Datei nicht nur an, sondern löscht sie nach dem Test auch wieder, inklusive des temporären Ordners.</p>

<h3>Timeout</h3>

<p>Es kommt gelegentlich vor, dass man Code schreibt, der versehentlich Endlosschleifen enthält. Ein JUnit-Test, der diese Codestellen testet, läuft in diese Endlosschleifen. Bei Verwendung der <code>Timeout</code>-Rule schlagen solche Tests fehl, da sie nicht innerhalb der vorgegebenen Zeit beendet werden.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalTimeout</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Timeout</span> <span class="n">timeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Timeout</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span> <span class="c1">//timeout nach 20 ms</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">firstTest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">secondTest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Führt man diesen Test aus, schlagen beide Testmethoden fehl. Würde man die Rule nicht verwenden, liefe dieser Test endlos.</p>

<p>Wer bisher den <code>timeout</code>-Parameter der <code>@Test</code>-Annotation verwendet hat, kann diesen durch die <code>Timeout</code>-Rule ersetzen. Die Rule bietet den Vorteil, dass sie nur einmal in der Klasse definiert werden muss und dann für alle Testmethoden gilt.</p>

<h3>Erwartete Exceptions</h3>

<p>Schon bisher kann das Auftreten von Exceptions mit dem <code>expected</code>-Parameter der <code>@Test</code>-Annotation getestet werden. Die <code>ExpectedException</code>-Rule erweitert die Test-Möglichkeiten für Exceptions. Damit lassen sich neben der Klasse auch die Message und mittels Hamcrest-Matchern sogar beliebige Details der geworfenen Exception testen.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExpectedExceptionWithRule</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span><span class="o">[]</span> <span class="n">threeNumbers</span> <span class="o">=</span> <span class="o">{</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span> <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Rule</span> <span class="kd">public</span> <span class="n">ExpectedException</span> <span class="n">thrown</span> <span class="o">=</span> <span class="n">ExpectedException</span><span class="o">.</span><span class="na">none</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exception</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">thrown</span><span class="o">.</span><span class="na">expect</span><span class="o">(</span><span class="n">ArrayIndexOutOfBoundsException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="n">threeNumbers</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionWithMessage</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">thrown</span><span class="o">.</span><span class="na">expect</span><span class="o">(</span><span class="n">ArrayIndexOutOfBoundsException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="n">thrown</span><span class="o">.</span><span class="na">expectMessage</span><span class="o">(</span><span class="s">&quot;3&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">threeNumbers</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Fehler sammeln</h3>

<p>Üblicherweise bricht ein Test nach der ersten fehlgeschlagenen Assertion ab. Will man in einem Test trotzdem alle Assertions abarbeiten, kann man den <code>ErrorCollector</code> verwenden. Er sammelt fehlgeschlagene Assertions innerhalb einer Testmethode und gibt am Ende eine Liste der Fehlschläge aus. So kann man etwa alle Elemente in einer Liste überprüfen und den Test erst am Ende fehlschlagen lassen, wenn die Überprüfung eines oder mehrerer Elemente fehlgeschlagen ist.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorCollectingTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">ErrorCollector</span> <span class="n">collector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorCollector</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">collector</span><span class="o">.</span><span class="na">checkThat</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
</span><span class='line'>      <span class="n">collector</span><span class="o">.</span><span class="na">addError</span><span class="o">(</span><span class="k">new</span> <span class="n">Exception</span><span class="o">(</span><span class="s">&quot;something went wrong&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wenn man diesen Test ausführt, erhält man zwei Fehlernachrichten mit jeweils einem Stacktrace, der einen zu der Zeile im Programmcode führt, wo die Überprüfung fehlgeschlagen ist.</p>

<h3>Testname</h3>

<p>Um innerhalb einer Testmethode auf deren Namen zuzugreifen, kann man die <code>TestName</code>-Rule verwendet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NameRuleTest</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">TestName</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestName</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">assertThat</span><span class="o">(</span><span class="n">test</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Rules selber schreiben</h2>

<p>Die von JUnit bereitgestellten Rules sind nur der Anfang. Wer sich das Schreiben von Tests erleichtern will, kann seine eigenen Rules schreiben. Das sind letztendlich Klassen, die das Interface <code>TestRule</code> mit der Methode <code>apply(...)</code> implementieren. Für die häufigsten Anwendungsfälle greift uns JUnit unter die Arme und stellt die drei Templateklassen <code>ExternalResource</code>, <code>TestWatcher</code> und <code>Verifier</code> zur Verfügung.</p>

<h3>Bereitstellung externer Ressourcen</h3>

<p>Vielfach werden, insbesondere bei Integrationstests, externe Ressourcen wie Dateien, Server oder Verbindungen benötigt. Diese müssen dem Test zur Verfügung gestellt und nach dessen Ausführung wieder aufgeräumt werden.</p>

<p>Dieses Ressourcenhandling lässt sich recht einfach mit einer Rule abbilden, indem man von der Basisklasse <code>ExternalResource</code> ableitet. In der neuen Rule überschreibt man die <code>before()</code>-Methode, um die Ressource bereitzustellen, und die <code>after()</code>-Methode um sie nach dem Test wieder aufzuräumen. Ein Beispiel hierfür ist die <code>TemporaryFolder</code>-Rule, die in der <code>before()</code>-Methode ein neues Verzeichnis erstellt und es in der <code>after()</code>-Methode wieder löscht.</p>

<p>Wie einfach sich eine solche Rule schreiben lässt, demonstriert das folgende Beispiel. Möchte man für einen Test sicherstellen, dass eine System Property einen bestimmten Wert hat und nach dem Test der alte Wert wiederhergestellt wird, könnte man die Methoden <code>before()</code> und <code>after()</code> wie folgt implementieren:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProvideSystemProperty</span> <span class="kd">extends</span> <span class="n">ExternalResource</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">oldValue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="nf">ProvideSystemProperty</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">oldValue</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>      <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">oldValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">clearProperty</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Und schon kann man die Rule in einem Test verwenden:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeTestUsingSystemProperty</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">ProvideSystemProperty</span> <span class="n">property</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProvideSystemProperty</span><span class="o">(</span><span class="s">&quot;someKey&quot;</span><span class="o">,</span> <span class="s">&quot;someValue&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">assertThat</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;someKey&quot;</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="s">&quot;someValue&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Benachrichtigung über die Testausführung</h3>

<p>Da man mit einer Rule Code vor und nach dem Aufruf der Testmethoden ausführen kann, lässt sich damit eine Benachrichtigung über die Testausführung realisieren. Dazu stellt JUnit die abstrakte Oberklasse <code>TestWatcher</code> bereit. Diese besitzt vier leer implementierte Methoden, die man nach Bedarf überschreiben kann: <code>starting()</code>, <code>succeeded()</code>, <code>failed()</code> und <code>finished()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeepOnFailure</span> <span class="kd">extends</span> <span class="n">TestWatcher</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">beep</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Die Benutzung in einem Test sieht dann so aus:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FailingTestThatBeeps</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">BeepOnFailure</span> <span class="n">beep</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeepOnFailure</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">fail</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Überprüfungen nach den Tests</h3>

<p>Das dritte von JUnit zur Verfügung gestellte Template ist der <code>Verifier</code>. Dort kann man die Methode <code>verify()</code> überschreiben, die nach jedem erfolgreichen Test ausgeführt wird. In dieser Methode lassen sich zusätzliche Überprüfungen unterbringen, die im Fehlerfall eine Exception werfen, um den Test doch noch scheitern zu lassen.</p>

<p>Eine Beispielimplementierung von <code>Verifier</code> ist der weiter oben vorgestellte <code>ErrorCollector</code>. Während des Testlaufs sammelt er alle fehlgeschlagenen Assertions und wirft im Fehlerfall eine <code>MultipleFailureException</code> am Ende des Tests.</p>

<h3>TestRule implementieren</h3>

<p>Anstatt eines der Templates zu verwenden kann man das Interface <code>TestRule</code> auch direkt implementieren. Dieses Interface hat genau eine Methode</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Statement</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Das erste Argument <code>base</code> kapselt den auszuführenden Test, der sich mittels <code>evaluate()</code> ausführen lässt. Die <code>description</code> stellt Informationen zum Test zu Verfügung (bspw. den Testnamen). Der Rückgabewert der Methode ist ein <code>Statement</code> dass anstelle des Tests ausgeführt wird. Üblicherweise delegiert das neue <code>Statement</code> den Aufruf von <code>evaluate()</code> an den ursprünglichen Test und führt zusätzlich weitere Methoden aus. Der folgende Code zeigt beispielhaft die leicht abgewandelte Implementierung des <code>ExternalResource</code>-Templates.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">Statement</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">Statement</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">before</span><span class="o">();</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">base</span><span class="o">.</span><span class="na">evaluate</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">after</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">};</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hier wird zuerst die Template-Methode <code>before()</code> ausgeführt, dann der Test selbst mittels <code>base.evaluate()</code> und zum Schluss die zweite Template-Methode <code>after()</code>.</p>

<h2>Regeln auf Klassenebene</h2>

<p>Alle Rules, die wir bisher gesehen haben, wurden für jede Methode einzeln angewandt, genauso wie Methoden, die mit <code>@Before</code> und <code>@After</code> annotiert sind, vor bzw. nach jedem Test ausgeführt werden. Manchmal möchte man allerdings die Möglichkeit haben, Code nur einmal vor der ersten bzw. nach der letzten Testmethode in einer Klasse auszuführen. Ein häufiger Anwendungsfall sind Integrationstests, die eine Verbindung zu einem Server aufbauen und wieder schließen müssen. Das war bisher nur mit den Annotations <code>@BeforeClass</code> bzw. <code>@AfterClass</code> möglich, Rules konnte man dazu nicht verwenden. Um dieses Problem zu lösen, wurde in JUnit 4.9 die <code>@ClassRule</code>-Annotation eingeführt.</p>

<p>Um eine <code>ClassRule</code> zu verwenden, annotiert man ein Feld in der Testklasse, das analog zu <code>@BeforeClass</code>-/<code>@AfterClass</code>-Methoden <code>public</code> und <code>static</code> sein muss. Der Typ des Feldes muss wie bei der <code>@Rule</code>-Annotation das <code>TestRule</code>-Interface implementieren. Eine solche Rule lässt sich nicht nur in einer normalen Testklasse verwenden, sondern auch in einer Test-Suite, wie das folgende Beispiel [<a href="http://github.com/KentBeck/junit/blob/master/doc/ReleaseNotes4.9.txt" title="JUnit 4.9 Release Notes">4</a>] illustriert:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Suite</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@SuiteClasses</span><span class="o">({</span><span class="n">A</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">B</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">C</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsesExternalResource</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Server</span> <span class="n">myServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Server</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ClassRule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ExternalResource</span> <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExternalResource</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>      <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">before</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">myServer</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
</span><span class='line'>      <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">after</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">myServer</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
</span><span class='line'>      <span class="o">};</span>
</span><span class='line'>  <span class="o">};</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Mehrere Regeln kombinieren</h2>

<p>Einen weiteren Vorteil von Rules gegenüber Hilfsmethoden in Testoberklassen stellt ihre Kombinierbarkeit dar. Es lassen sich beliebig viele Rules in einem Test verwenden:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CombiningMultipleRules</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Rule</span> <span class="kd">public</span> <span class="n">TestRule</span> <span class="n">beep</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeepOnFailure</span><span class="o">();</span>
</span><span class='line'>  <span class="nd">@Rule</span> <span class="kd">public</span> <span class="n">ExpectedException</span> <span class="n">exceptions</span> <span class="o">=</span> <span class="n">ExpectedException</span><span class="o">.</span><span class="na">none</span><span class="o">();</span>
</span><span class='line'>  <span class="nd">@Rule</span> <span class="kd">public</span> <span class="n">TestName</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestName</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">exceptions</span><span class="o">.</span><span class="na">expect</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Hello from &quot;</span> <span class="o">+</span> <span class="n">test</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Das funktioniert wunderbar, solange die Rules voneinander unabhängig sind. JUnit macht absichtlich keinerlei Zusicherungen was die Reihenfolge der Abarbeitung von Rules angeht [<a href="http://tech.groups.yahoo.com/group/junit/message/23537" title="Mailing List Post von Kent Beck über das Design von Rules">5</a>]. Manchmal möchte man aber dennoch eine bestimmte Reihenfolge vorgeben. Angenommen man hat zwei Rules, von denen die erste eine bestimmte Ressource zur Verfügung stellt, die von der zweiten Rule benutzt wird. Dann möchte man sehr wohl sicherstellen, dass zuerst die Ressource bereitgestellt wird, bevor sie konsumiert wird. Dafür wurde in JUnit 4.10 die <code>RuleChain</code>-Klasse eingeführt. <code>RuleChain</code> implementiert selbst das <code>TestRule</code>-Interface, kann also verwendet werden, wie eine normale Rule [<a href="http://github.com/KentBeck/junit/blob/master/doc/ReleaseNotes4.10.txt" title="JUnit 4.10 Release Notes">6</a>]:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UseRuleChain</span> <span class="o">{</span>
</span><span class='line'>  <span class="nd">@Rule</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">TestRule</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">RuleChain</span><span class="o">.</span><span class="na">outerRule</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingRule</span><span class="o">(</span><span class="s">&quot;outer rule&quot;</span><span class="o">))</span>
</span><span class='line'>          <span class="o">.</span><span class="na">around</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingRule</span><span class="o">(</span><span class="s">&quot;middle rule&quot;</span><span class="o">))</span>
</span><span class='line'>          <span class="o">.</span><span class="na">around</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingRule</span><span class="o">(</span><span class="s">&quot;inner rule&quot;</span><span class="o">));</span>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wenn man diesen Test ausführt, erhält man folgende Ausgabe:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">starting</span> <span class="n">outer</span> <span class="n">rule</span>
</span><span class='line'><span class="n">starting</span> <span class="n">middle</span> <span class="n">rule</span>
</span><span class='line'><span class="n">starting</span> <span class="n">inner</span> <span class="n">rule</span>
</span><span class='line'><span class="n">finished</span> <span class="n">inner</span> <span class="n">rule</span>
</span><span class='line'><span class="n">finished</span> <span class="n">middle</span> <span class="n">rule</span>
</span><span class='line'><span class="n">finished</span> <span class="n">outer</span> <span class="n">rule</span>
</span></code></pre></td></tr></table></div></figure>


<p>Die erste Regel (<code>outer rule</code>) umschließt also die mittlere (<code>middle rule</code>) und diese wiederum die dritte und letzte (<code>inner rule</code>).</p>

<h2>Schreib deine eigenen Regeln!</h2>

<p>Warum sollte man Rules verwenden? Ein großer Pluspunkt von Rules ist ihre <em>Wiederverwendbarkeit</em>. Sie ermöglichen häufig benutzten Code, der bisher in <code>@Before</code>/<code>@After</code>-Methoden oder einer Testoberklasse stand, in eine eigene <code>TestRule</code>-Klasse auszulagern, die nur eine Verantwortlichkeit hat.</p>

<p>Ein weiterer Vorteil ist die <em>Kombinierbarkeit</em> von Rules. Wie wir in diesem Artikel gesehen haben, lassen sich beliebig viele Regeln in einem Test verwenden, sowohl auf Klassen- als auch auf Methodenebene. Viele Dinge, für die es in der Vergangenheit eines eigenen Test Runners bedurfte, lassen sich jetzt mit Rules implementieren. Da man immer nur einen Test Runner aber beliebig viele Rules verwenden kann, stehen einem deutlich mehr Möglichkeiten offen.</p>

<p>Rules sind die Umsetzung von <em>Delegation statt Vererbung</em> für Unittests. Wo früher Testklassenhierarchien mit Utility-Methoden gewuchert sind, kann man jetzt auf einfache Art und Weise verschiedene Rules kombinieren.</p>

<p>Die vorgestellten, konkreten Rules demonstrieren lediglich die Vielfältigkeit der Einsatzmöglichkeiten. Eigene Regeln zu schreiben ist Dank der zur Verfügung gestellten Templateklassen einfach. Erst diese <em>Erweiterbarkeit</em> macht Rules zu einem wirklichen Novum.</p>

<p>Die Macher von JUnit setzen jedenfalls für die Zukunft von JUnit voll auf den Einsatz und die Erweiterung von Rules. Kent Beck schreibt darüber in seinem Blog [<a href="http://www.threeriversinstitute.org/blog/?p=155" title="Blog von Kent Beck">7</a>]: „Maybe once every five years unsuspectedly powerful abstractions drop out of a program with no apparent effort.”</p>

<h2>Links &amp; Literatur</h2>

<ol>
<li><a href="http://www.xprogramming.com/testfram.htm" title="Kent Beck, Simple Smalltalk Testing: With Patterns">Kent Beck, Simple Smalltalk Testing: With Patterns</a></li>
<li><a href="http://blog.schauderhaft.de/2009/10/04/junit-rules/" title="Blog von Jens Schauder">Blog von Jens Schauder</a></li>
<li><a href="http://marcphilipp.github.com/junit-rules/" title="Source Code der Beispiele auf GitHub">Source Code der Beispiele auf GitHub</a></li>
<li><a href="http://github.com/KentBeck/junit/blob/master/doc/ReleaseNotes4.9.txt" title="JUnit 4.9 Release Notes">JUnit 4.9 Release Notes</a></li>
<li><a href="http://tech.groups.yahoo.com/group/junit/message/23537" title="Mailing List Post von Kent Beck über das Design von Rules">Mailing List Post von Kent Beck über das Design von Rules</a></li>
<li><a href="http://github.com/KentBeck/junit/blob/master/doc/ReleaseNotes4.10.txt" title="JUnit 4.10 Release Notes">JUnit 4.10 Release Notes</a></li>
<li><a href="http://www.threeriversinstitute.org/blog/?p=155" title="Blog von Kent Beck">Blog von Kent Beck</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Primitive Matt(ch)ers?]]></title>
    <link href="http://www.marcphilipp.de/blog/2010/11/16/primitive-matt-ch-ers/"/>
    <updated>2010-11-16T20:34:00+01:00</updated>
    <id>http://www.marcphilipp.de/blog/2010/11/16/primitive-matt-ch-ers</id>
    <content type="html"><![CDATA[<p>The <a href="http://code.google.com/p/hamcrest/">Hamcrest project</a> provides a large number of matchers, i.e. declaratively defined predicates. Prominent uses of these matchers include testing and mocking libraries like JUnit and jMock, respectively.</p>

<h3>How to use them?</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onePlusOneIsTwo</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the above example is simple, it demonstrates one of the benefits of using <code>assertThat()</code> and Hamcrest matchers: assertions become very readable. Unfortunately, you often have to rely on a questionable Java mechanism: auto boxing/unboxing.</p>

<p>Auto boxing and unboxing have been introduced in Java 5 to ease the use of primitive types and their counterparts: <em>real</em> objects (a.k.a. reference types). However, especially unboxing can lead to hidden NullPointerExceptions and thus is discouraged by many developers. For details see <a href="http://pboop.wordpress.com/2010/09/22/autoboxing-is-evil/">Autoboxing is Evil</a> by Nicole Rauch and Andreas Leidig.</p>

<p>For this reason, the Eclipse Java compiler optionally shows warnings whenever boxing or unboxing occurs. While it is certainly a good idea to enable this warning, it also puts markers on code that is perfectly sane, like the test case above. To prevent un-/boxing and use matchers at the same time, one can go back to pre-Java 5 times and convert the
primitive literals explicitly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onePlusOneIsTwo</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">),</span> <span class="n">is</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">2</span><span class="o">)));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, this is not readable anymore!</p>

<h3>Why do we need boxing in the first place?</h3>

<p>When using <code>assertThat()</code> we need boxing for two reasons. First, there is no definition of <code>assertThat()</code> for primitive types, only for reference types:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">assertThat</span><span class="o">(</span><span class="n">T</span> <span class="n">actual</span><span class="o">,</span> <span class="n">Matcher</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">matcher</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, why don&#8217;t we overload <code>assertThat()</code> with separate method definitions for each primitive type, you might say.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">assertThat</span><span class="o">(</span><span class="kt">int</span> <span class="n">actual</span><span class="o">,</span> <span class="n">Matcher</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">matcher</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Java&#8217;s generics do not allow primitive types like <code>int</code> as type arguments, only reference types are allowed.</p>

<h3>Hmm, anything we <em>can</em> do?</h3>

<p>Yes! So how about</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">assertThat</span><span class="o">(</span><span class="kt">int</span> <span class="n">actual</span><span class="o">,</span> <span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">matcher</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">actual</span><span class="o">),</span> <span class="n">matcher</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without using auto boxing, we can now write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onePlusOneIsTwo</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">2</span><span class="o">)));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That solves half of our problem: We got rid of the first boxing by overloading <code>assertEquals()</code>. However, we still need to explicity convert our <code>int</code> to <code>Integer</code> when calling the matcher factory method. Thus, we also need to overload the <code>is()</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Problem solved! Really? Obviously, it requires a lot of work do define extra matcher factory methods for every combination of primitive type and matcher.</p>

<h3>Solution: generate it!</h3>

<p>Hamcrest already allows to <a href="http://code.google.com/p/hamcrest/wiki/Tutorial#Sugar_generation">generate matcher libraries</a>, i.e. classes that collect all static factory methods for easy access at a single entry point. So, we could simply generate extra methods for every matcher. To stay with the example from above, if we have an
unrestricted <code>Matcher&lt;T&gt;</code>, we would generate the following eight overloading methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Byte</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">byte</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Byte</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Short</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">short</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Short</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">long</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Float</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">float</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Float</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">double</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">&gt;</span> <span class="n">is</span><span class="o">(</span><span class="kt">char</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">is</span><span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A matcher declaration which uses the object representation of a primitive type, e.g. <code>Matcher&lt;Integer&gt;</code>, is a special case that is even more simple. We would only need to generate a single extra method, such as</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">zero</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">zero</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Summing up, it would be great if Hamcrest provided built-in support for primitive types.</p>

<h3>Update</h3>

<p>My proposal was <a href="http://code.google.com/p/hamcrest/issues/detail?id=130">rejected</a> by the Hamcrest maintainers.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Combining SuiteBuilder and ClasspathSuite]]></title>
    <link href="http://www.marcphilipp.de/blog/2010/05/13/combining-suitebuilder-and-classpathsuite/"/>
    <updated>2010-05-13T13:05:00+02:00</updated>
    <id>http://www.marcphilipp.de/blog/2010/05/13/combining-suitebuilder-and-classpathsuite</id>
    <content type="html"><![CDATA[<p>In a recent <a href="http://github.com/KentBeck/junit/commit/f09cff79b941a525271f3f2838a9742b4c5c8d36">commit</a> to JUnit Kent Beck and David Saff have added an &#8220;alpha-ready implementation of <code>SuiteBuilder</code>&#8221;. As Kent Beck previously described in a <a href="http://www.threeriversinstitute.org/blog/?p=456">blog post</a>, the idea behind the <code>SuiteBuilder</code> runner is to use annotations on fields instead of annotations on classes.</p>

<h3>Limitations of regular test suites</h3>

<p>While an annotation can take parameters the arguments must be literals, e.g. constant String values or class literals. For example, the classic <code>Suite</code> runner is configured using the <code>@SuiteClasses</code> annotation that takes an array of class literals, i.e. the test classes to be run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Suite</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@SuiteClasses</span><span class="o">({</span>
</span><span class='line'>    <span class="n">SomeTest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span><span class='line'>    <span class="n">YetAnotherTest</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'><span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllTests</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Literals have a severe limitation: they must be know at compile-time! Thus, when using the <code>Suite</code> runner, there was no way of determining the classes to run by any other means such as scanning the current classpath.</p>

<h3>ClasspathSuite to the rescue</h3>

<p>For this original purpose, Johannes Link created the <a href="http://johanneslink.net/projects/cpsuite.jsp"><code>ClasspathSuite</code></a> runner. Its basic usage is very simple: just specify it using the <code>@RunWith</code> annotation. In addition, you can also include test classes in JAR files, filter by class names or types, and so on:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">ClasspathSuite</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@IncludeJars</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'><span class="nd">@ClassnameFilters</span><span class="o">({</span><span class="s">&quot;.*Test&quot;</span><span class="o">,</span> <span class="s">&quot;!.*AllTests&quot;</span><span class="o">})</span>
</span><span class='line'><span class="nd">@BaseTypeFilter</span><span class="o">(</span><span class="n">MyBaseTest</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllTests</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, the <code>ClasspathSuite</code> does not support JUnit&#8217;s categories as mentioned in an <a href="http://www.marcphilipp.de/blog/2010/03/13/applying-dry-to-junit-categories/">earlier blog post</a>. While it could certainly be extended to support the Category-related annotations <code>@IncludeCategory</code> and <code>@ExcludeCategory</code>, the <code>SuiteBuilder</code> offers a more flexible alternative.</p>

<h3>Introducing SuiteBuilder</h3>

<p>The <code>SuiteBuilder</code> runner is similar to the <code>Suite</code> runner, but reads the test classes it is supposed to run from a field of the suite class annotated with <code>@Classes</code>. The field can be freely initialized to hold an implementation of the <code>SuiteBuilder.Classes.Value</code> interface which simply wraps a collection of classes. E.g., the first example can be rewritten using the <code>SuiteBuilder</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SuiteBuilder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllTests</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Classes</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Listed</span> <span class="n">classes</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">Listed</span><span class="o">(</span><span class="n">SomeTest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">YetAnotherTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In addition, you can filter the resulting test runners by annotating a field of type <code>SuiteBuilder.RunnerFilter.Value</code> with <code>@RunnerFilter</code>. For example, the latest commit included a <code>CategoryFilter</code> that filters tests by category:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SuiteBuilder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlyYes</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Classes</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Listed</span> <span class="n">classes</span> <span class="o">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">Listed</span><span class="o">(</span><span class="n">SomeTest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">YetAnotherTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@RunnerFilter</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">CategoryFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">CategoryFilter</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">Yes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Putting the pieces together</h3>

<p>So what? Well, instead of specifying the classes explicitly you could employ the capabilities of the <code>ClasspathSuite</code> to determine the test classes dynamically. For this purpose, I have written a small wrapper around Johannes Links&#8217; <code>ClasspathSuite</code>. The above example can thus be rewritten without explicitly specifying the test classes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SuiteBuilder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlyYes</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Classes</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">InClasspath</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InClasspath</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@RunnerFilter</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">CategoryFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">CategoryFilter</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">Yes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The wrapper offers the same flexibility as the <code>ClasspathSuite</code>, e.g.:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SuiteBuilder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlyYes</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Classes</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">InClasspath</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InClasspath</span><span class="o">().</span><span class="na">includingJars</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">filteredBy</span><span class="o">(</span><span class="s">&quot;.*Test&quot;</span><span class="o">,</span> <span class="s">&quot;!.*AllTests&quot;</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">includingOnlySubclassesOf</span><span class="o">(</span><span class="n">MyBaseTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@RunnerFilter</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">CategoryFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">CategoryFilter</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">Yes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While I will look into how this can be integrated into JUnit or ClasspathSuite feel free to contact me if you are interested in the source code of the <code>InClasspath</code> class.</p>

<h3>Update</h3>

<p>I am currently working on integrating ClasspathSuite and InClasspath into core JUnit&#8230; In the meantime, you can <a href="http://github.com/marcphilipp/junit/tree/master/src/main/java/org/junit/experimental/cpsuite/">take a look at the code on GitHub</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Applying DRY to JUnit Categories]]></title>
    <link href="http://www.marcphilipp.de/blog/2010/03/13/applying-dry-to-junit-categories/"/>
    <updated>2010-03-13T22:08:00+01:00</updated>
    <id>http://www.marcphilipp.de/blog/2010/03/13/applying-dry-to-junit-categories</id>
    <content type="html"><![CDATA[<p>Long awaited, <a href="http://kentbeck.github.com/junit/doc/ReleaseNotes4.8.html">JUnit 4.8</a> introduced support for categorizing test cases.</p>

<p>A category marker is simply a class or interface, e.g.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SlowTests</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tests can be marked using the <code>@Category</code> annotation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Category</span><span class="o">(</span><span class="n">SlowTests</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">b</span><span class="o">()</span> <span class="o">{}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The annotation works both on methods and classes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Category</span><span class="o">(</span><span class="n">SlowTests</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">B</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">c</span><span class="o">()</span> <span class="o">{}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test suites that include or exclude the <code>SlowTests</code> category are defined by specifying the <code>Categories</code> runner and using the <code>@ExcludeCategory</code> or <code>@IncludeCategory</code> annotation, respectively:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Categories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@SuiteClasses</span><span class="o">(</span> <span class="o">{</span> <span class="n">A</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">B</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span><span class='line'><span class="nd">@ExcludeCategory</span><span class="o">(</span><span class="n">SlowTests</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllFastTests</span> <span class="kd">extends</span> <span class="n">AllTests</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Categories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@SuiteClasses</span><span class="o">(</span> <span class="o">{</span> <span class="n">A</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">B</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span><span class='line'><span class="nd">@IncludeCategory</span><span class="o">(</span><span class="n">SlowTests</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllSlowTests</span> <span class="kd">extends</span> <span class="n">AllTests</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, <code>AllFastTests</code> would execute only <code>A.a</code> while <code>AllSlowTests</code> would ignore <code>A.a</code> but run <code>A.b</code> and <code>B.c</code>.</p>

<p>However, there is a major issue in the above suite declarations: they violate the <a href="http://c2.com/cgi/wiki?DontRepeatYourself" title="Don't Repeat Yourself">DRY</a> principle. Both test suites list all test classes in the <code>@SuiteClasses</code> annotation. While it seems feasible to maintain the list of test classes at two locations for a small number of classes, it certainly is not a viable option in a real-world setting, especially when there are multiple categories.</p>

<p>Fortunately, there is a simple solution: use inheritance. You can define the list of test classes once in a normal test suite …</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Suite</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@SuiteClasses</span><span class="o">(</span> <span class="o">{</span> <span class="n">A</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">B</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllTests</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>… and declare subclasses that filter the list of classes by category:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Categories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@ExcludeCategory</span><span class="o">(</span><span class="n">SlowTests</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllFastTests</span> <span class="kd">extends</span> <span class="n">AllTests</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Categories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@IncludeCategory</span><span class="o">(</span><span class="n">SlowTests</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllSlowTests</span> <span class="kd">extends</span> <span class="n">AllTests</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Generic Matcher Pitfalls]]></title>
    <link href="http://www.marcphilipp.de/blog/2010/02/16/generic-matcher-pitfalls/"/>
    <updated>2010-02-16T22:45:00+01:00</updated>
    <id>http://www.marcphilipp.de/blog/2010/02/16/generic-matcher-pitfalls</id>
    <content type="html"><![CDATA[<p>Using <a href="http://code.google.com/p/hamcrest/">Hamcrest</a> matchers in combination with <code>assertThat</code> allows for more fluid specification of JUnit assertions.</p>

<p>Recently, while working on the backend of <a href="http://projectusus.org/">Project Usus</a>, we needed a simple matcher, that would test whether a given set is empty. At the time, we reused a set matcher we had already written a few minutes earlier.</p>

<p>Today, I had another look at the pre-defined matchers that come with Hamcrest and found the <code>empty()</code> matcher in <code>org.hamcrest.Matchers</code>. Since I&#8217;m not concerned with the actual implementation (at least for now), I&#8217;ll just give you the factory method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Factory</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span> <span class="n">empty</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">IsEmptyCollection</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great, I thought. So I readily changed our tests to use the pre-defined matcher…</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">assertThat</span><span class="o">(</span><span class="k">new</span> <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(),</span> <span class="n">empty</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, this yielded a compile error because the compiler could not infer the type parameter of the method. It <em>did</em> work when stating the type parameter of the static method explicitly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">assertThat</span><span class="o">(</span><span class="k">new</span> <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(),</span> <span class="n">Matchers</span><span class="o">.&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="n">empty</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>But that looked horrible. My first shot was to define an own factory method…</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Factory</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span> <span class="n">emptyOf</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">IsEmptyCollection</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>…that can be used like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">assertThat</span><span class="o">(</span><span class="k">new</span> <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(),</span> <span class="n">emptyOf</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was still not very pleased with the solution. Even more since it does not matter at all what kind of objects are inside the collection to determine whether it is empty. After playing around for a little while I came up with this solution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IsEmptyCollection</span> <span class="kd">extends</span> <span class="n">TypeSafeMatcher</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">matchesSafely</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">collection</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">collection</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">describeTo</span><span class="o">(</span><span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">description</span><span class="o">.</span><span class="na">appendText</span><span class="o">(</span><span class="s">&quot;empty&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Factory</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">empty</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">IsEmptyCollection</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In conclusion, I think it is not trivial to write usable generic matchers. Therefore, avoid generics when you don&#8217;t need them!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Experimenting with Theories]]></title>
    <link href="http://www.marcphilipp.de/blog/2010/02/13/experimenting-with-theories/"/>
    <updated>2010-02-13T14:04:00+01:00</updated>
    <id>http://www.marcphilipp.de/blog/2010/02/13/experimenting-with-theories</id>
    <content type="html"><![CDATA[<p>The very first 4.x release of JUnit contained support for custom test runners. Moreover, it came with the <code>Parameterized</code> test runner that allows to execute the test cases in a test class against a collection of values, i.e. parameters.</p>

<p>The example that comes with the Javadoc of the <code>Parameterized</code> class tests an imaginary Fibonacci calculator for a number of data points:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Parameterized</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FibonacciParameterizedTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Parameters</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">[]&gt;</span> <span class="n">data</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[][]</span> <span class="o">{</span> <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span> <span class="o">},</span> <span class="o">{</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span> <span class="o">},</span>
</span><span class='line'>                <span class="o">{</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">1</span> <span class="o">},</span> <span class="o">{</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2</span> <span class="o">},</span> <span class="o">{</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">3</span> <span class="o">},</span> <span class="o">{</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">5</span> <span class="o">},</span> <span class="o">{</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">8</span> <span class="o">}</span> <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">input</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">expected</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">FibonacciParameterizedTest</span><span class="o">(</span><span class="kt">int</span> <span class="n">input</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expected</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">input</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="n">expected</span><span class="o">,</span> <span class="n">Fibonacci</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="n">input</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>JUnit 4.4 introduced Theories. A theory is an abstraction of a concrete test scenario, i.e. while a test specifies the behavior in one particular case, a theory captures more than a single scenario but is usually not as detailed in its assertions.</p>

<p>When using a Parameterized test you usually specify the input along with the expected output. Of course, you can do the same with a theory. However, theories allow for a complete different approach to testing the Fibonacci calculator.</p>

<p>E.g. a simple theory could state that for one of the seeds, i.e. 0 or 1, the same number is returned as result. Another theory could test the recurrence relation, i.e. that <code>Fibonacci(n)</code> always equals <code>Fibonacci(n-1)</code> + <code>Fibonacci(n-2)</code>. In Java this can be written as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Theories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FibonacciTheories</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@DataPoints</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">VALUES</span> <span class="o">=</span> <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span> <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Theory</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">seeds</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">assumeTrue</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">compute</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Theory</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recurrence</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">assumeTrue</span><span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="n">compute</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">compute</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">),</span> <span class="n">compute</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Even shorter yet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Theories</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FibonacciTheories</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Theory</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">seeds</span><span class="o">(</span><span class="nd">@TestedOn</span><span class="o">(</span><span class="n">ints</span> <span class="o">=</span> <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span> <span class="o">})</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">compute</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Theory</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recurrence</span><span class="o">(</span><span class="nd">@TestedOn</span><span class="o">(</span><span class="n">ints</span> <span class="o">=</span> <span class="o">{</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span> <span class="o">})</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="n">compute</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">compute</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">),</span> <span class="n">compute</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, which test is better? Actually, I am still undecided. While theories certainly look more elegant, a parameterized tests states its assumptions more clearly. The answer seems to be, as always: It depends.</p>
]]></content>
  </entry>
  
</feed>
